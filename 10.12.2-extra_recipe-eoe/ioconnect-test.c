#include <stdio.h>
#include <stdlib.h>
#include <IOKit/IOKitLib.h>
#include <mach/mach.h>      // mach_port_allocate, mach_port_insert_right

/* gcc ioconnect-test.c -o ioconnect-test -framework IOKit */

#define HEAP_OBJECTS_NR 1000

#define EXIT_ON_MACH_ERROR(msg, kr) \
  if (kr != KERN_SUCCESS) { \
    mach_error(msg ":" , kr); \
    exit((kr)); \
  }

io_connect_t kalloc_unknown(char *serv)
{
    io_service_t  service   = 0;
    io_connect_t  connect   = MACH_PORT_NULL;
    io_iterator_t iterator  = 0;
    kern_return_t kr        = 0;

    kr = IOServiceGetMatchingServices(kIOMasterPortDefault,
                                      IOServiceMatching(serv),
                                      &iterator);
    EXIT_ON_MACH_ERROR("IOServiceGetMatchingServices", kr);

    io_object_t object = IOIteratorNext(iterator);
    if (object == IO_OBJECT_NULL)
    {
        printf("UserClient %s not found.\n", serv);
        exit(0);
    }
    kr = IOServiceOpen(object, mach_task_self(), 0, &connect);
    EXIT_ON_MACH_ERROR("IOServiceOpen", kr);

    return connect;
}

int main(int argc, char *argv[])
{
    system("sudo zprint kalloc");
    uint64_t alloc_table[HEAP_OBJECTS_NR];
    for (int i = 0; i < HEAP_OBJECTS_NR; i++)
    {
        alloc_table[i] = kalloc_unknown(argv[1]);
    }
    system("sudo zprint kalloc");
    sleep(1);
}
